---
import { getCollection } from 'astro:content';
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import Stats from '~/components/widgets/Stats.astro';
import Features from '~/components/widgets/Features.astro';
import FAQs from '~/components/widgets/FAQs.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import StructuredData from '~/components/common/StructuredData.astro';
import { Icon } from 'astro-icon/components';
import { fetchPosts } from '~/utils/blog';
import { getPermalink } from '~/utils/permalinks';
import { findImage } from '~/utils/images';
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';

const metadata = {
  title: 'Events | Mage-OS Community',
  description:
    'Join the Mage-OS community at events worldwide. From Meet Magento conferences to weekly tech meetings on Discord, connect with merchants, developers, and agencies shaping the future of open-source commerce.',
};

// Get all events and sort by eventDate
const allEvents = await getCollection('event');
const now = new Date();

const sortedEvents = allEvents.sort(
  (a, b) => new Date(b.data.eventDate).getTime() - new Date(a.data.eventDate).getTime()
);

// Upcoming events sorted chronologically (soonest first)
const upcomingEvents = sortedEvents
  .filter((event) => new Date(event.data.eventDate) >= now)
  .sort((a, b) => new Date(a.data.eventDate).getTime() - new Date(b.data.eventDate).getTime());

// Past events sorted by most recent first, limited to 12
const pastEvents = sortedEvents.filter((event) => new Date(event.data.eventDate) < now).slice(0, 12);

// Get latest 4 blog posts from Events category
const allPosts = await fetchPosts();
const eventPosts = allPosts
  .filter((post) => post.category?.title === 'Events')
  .slice(0, 4);

// Prepare event posts with images
const eventPostsWithImages = await Promise.all(
  eventPosts.map(async (post) => ({
    ...post,
    resolvedImage: (await findImage(post.image)) as ImageMetadata | string | undefined,
  }))
);

function formatDate(date: Date) {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(new Date(date));
}

// Event types for visual categorization
const eventTypes = [
  {
    title: 'Meet Magento Conferences',
    description:
      'Regional conferences bringing together the global Magento ecosystem for talks, networking, and innovation.',
    icon: 'tabler:users-group',
  },
  {
    title: 'Hackathons & Contribution Days',
    description: 'Hands-on events where developers collaborate on Mage-OS improvements and community projects.',
    icon: 'tabler:code',
  },
  {
    title: 'Weekly Tech Meetings',
    description: 'Join our weekly Discord calls to discuss development, roadmap, and community initiatives.',
    icon: 'tabler:calendar-repeat',
  },
  {
    title: 'Local Meetups',
    description: 'Community-organized gatherings in cities around the world for networking and knowledge sharing.',
    icon: 'tabler:map-pin',
  },
];
---

<Layout metadata={metadata}>
  <!-- Structured Data for upcoming events -->
  {
    upcomingEvents.map((event) => (
      <StructuredData
        type="Event"
        data={{
          name: event.data.title,
          startDate: new Date(event.data.eventDate).toISOString(),
          endDate: event.data.endDate ? new Date(event.data.endDate).toISOString() : undefined,
          description: event.data.excerpt || `${event.data.title} - A Mage-OS community event`,
          location: event.data.location
            ? {
                '@type': 'Place',
                name: event.data.location,
              }
            : undefined,
          url: event.data.url || `https://mage-os.org/events`,
          eventStatus: 'https://schema.org/EventScheduled',
          eventAttendanceMode: 'https://schema.org/OfflineEventAttendanceMode',
        }}
      />
    ))
  }

  <Hero
    tagline="Connect & Collaborate"
  >
    <Fragment slot="title">
      Community <span class="text-accent dark:text-white">Events</span>
    </Fragment>

    <Fragment slot="subtitle">
      From Meet Magento conferences across the globe to weekly tech meetings on Discord, the Mage-OS community gathers
      to share knowledge, build connections, and shape the future of open-source commerce. Whether you are a merchant
      exploring solutions, a developer contributing code, or an agency scaling implementations, there is an event for
      you.
    </Fragment>
  </Hero>

  <section class="px-4 py-8 sm:px-6 mx-auto lg:px-8 lg:py-12 max-w-6xl">
    {
      upcomingEvents.length > 0 && (
        <section class="mb-16" aria-labelledby="upcoming-events-heading">
          <h2 id="upcoming-events-heading" class="text-3xl font-bold tracking-tight dark:text-white sm:text-4xl mb-8">
            Upcoming Events
          </h2>
          <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3" role="list">
            {upcomingEvents.map((event) => (
              <article
                class="group bg-white dark:bg-slate-800 rounded-xl shadow-md hover:shadow-xl transition-all duration-300 border border-gray-200 dark:border-slate-700 overflow-hidden"
                role="listitem"
              >
                {event.data.image && (
                  <div class="h-40 overflow-hidden">
                    <img
                      src={`/images/events/${event.data.image}`}
                      alt={event.data.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      loading="lazy"
                    />
                  </div>
                )}
                <div class="bg-gradient-to-r from-primary/10 to-orange-100 dark:from-primary/20 dark:to-slate-700 p-4">
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold text-primary dark:text-blue-400">
                      {formatDate(event.data.eventDate)}
                      {event.data.endDate &&
                        event.data.endDate.getTime() !== event.data.eventDate.getTime() &&
                        ` - ${formatDate(event.data.endDate)}`}
                    </span>
                    {event.data.location && (
                      <span class="inline-flex items-center text-xs text-gray-600 dark:text-slate-400 bg-white/80 dark:bg-slate-900/50 px-2 py-1 rounded-full">
                        <Icon name="tabler:map-pin" class="w-3 h-3 mr-1" />
                        In-Person
                      </span>
                    )}
                  </div>
                </div>
                <div class="p-6">
                  <h3 class="text-xl font-bold mb-3 dark:text-white group-hover:text-primary dark:group-hover:text-blue-400 transition-colors">
                    {event.data.title}
                  </h3>
                  {event.data.location && (
                    <p class="text-gray-600 dark:text-slate-400 text-sm mb-3 flex items-center">
                      <Icon name="tabler:map-pin" class="w-4 h-4 mr-2 text-gray-400 dark:text-slate-500" />
                      {event.data.location}
                    </p>
                  )}
                  {event.data.excerpt && (
                    <p class="text-gray-600 dark:text-slate-400 text-sm mb-4 line-clamp-2">{event.data.excerpt}</p>
                  )}
                  {event.data.url && (
                    <a
                      href={event.data.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center text-primary dark:text-blue-400 font-medium text-sm hover:underline group-hover:gap-2 transition-all"
                    >
                      View Details
                      <Icon
                        name="tabler:arrow-right"
                        class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform"
                      />
                    </a>
                  )}
                </div>
              </article>
            ))}
          </div>
        </section>
      )
    }

    {
      upcomingEvents.length === 0 && (
        <div class="mb-16 text-center py-16 bg-gradient-to-br from-gray-50 to-orange-50/50 dark:from-slate-800 dark:to-slate-800/50 rounded-xl border border-gray-200 dark:border-slate-700">
          <Icon name="tabler:calendar-off" class="w-16 h-16 mx-auto text-gray-300 dark:text-slate-600 mb-4" />
          <h2 class="text-2xl font-bold tracking-tight dark:text-white mb-4">No Currently Scheduled Events</h2>
          <p class="text-gray-600 dark:text-slate-400 mb-6 max-w-md mx-auto">
            Check back soon for new events, or join our weekly Discord meetings to stay connected with the community.
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a
              href="/discord-channel"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-white font-medium px-6 py-3 rounded-lg transition-colors"
            >
              <Icon name="tabler:brand-discord" class="w-5 h-5" />
              Join Discord
            </a>
            <a
              href="https://calendar.google.com/calendar/u/0/embed?src=9ns1e12ucfd84tpnsehekkc6g0@group.calendar.google.com"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center gap-2 border border-gray-300 dark:border-slate-600 hover:bg-gray-100 dark:hover:bg-slate-700 font-medium px-6 py-3 rounded-lg transition-colors dark:text-white"
            >
              <Icon name="tabler:calendar" class="w-5 h-5" />
              View Community Calendar
            </a>
          </div>
        </div>
      )
    }
  </section>

  <!-- Weekly Tech Meetings Highlight -->
  <section class="bg-orange-50 dark:bg-slate-800 not-prose">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-8">
      <div class="flex flex-col md:flex-row items-center justify-between gap-6">
        <div class="flex items-center gap-4">
          <div class="bg-primary/10 dark:bg-primary/20 p-3 rounded-full">
            <Icon name="tabler:calendar-repeat" class="w-8 h-8 text-primary dark:text-blue-400" />
          </div>
          <div>
            <h2 class="text-xl font-bold dark:text-white">Weekly Tech Meetings</h2>
            <p class="text-gray-600 dark:text-slate-400">
              Join us every week on Discord to discuss development, roadmap priorities, and community initiatives.
            </p>
          </div>
        </div>
        <a
          href="/discord-channel"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 bg-primary hover:bg-primary/90 text-white font-medium px-6 py-3 rounded-lg transition-colors whitespace-nowrap"
        >
          <Icon name="tabler:brand-discord" class="w-5 h-5" />
          Join on Discord
        </a>
      </div>
    </div>
  </section>

  <!-- Why Attend Section -->
  <Features
    title="Why Attend Mage-OS Events?"
    subtitle="Our events offer unique opportunities to grow your skills, expand your network, and contribute to the open-source commerce ecosystem."
    columns={3}
    items={[
      {
        title: 'Learn From Experts',
        description:
          'Gain insights from industry leaders, core contributors, and experienced practitioners sharing real-world knowledge.',
        icon: 'tabler:school',
      },
      {
        title: 'Network Globally',
        description:
          'Connect with merchants, developers, and agencies from around the world who share your passion for open-source commerce.',
        icon: 'tabler:network',
      },
      {
        title: 'Shape the Future',
        description:
          'Participate in discussions that influence the Mage-OS roadmap and contribute to community-driven innovation.',
        icon: 'tabler:rocket',
      },
      {
        title: 'Hands-On Experience',
        description:
          'Join hackathons and contribution days to collaborate on real projects and improve your technical skills.',
        icon: 'tabler:code',
      },
      {
        title: 'Stay Current',
        description:
          'Keep up with the latest developments, best practices, and emerging trends in the Magento ecosystem.',
        icon: 'tabler:trending-up',
      },
      {
        title: 'Find Partners',
        description:
          'Discover agencies, technology providers, and collaborators who can help you achieve your commerce goals.',
        icon: 'tabler:heart-handshake',
      },
    ]}
  />

  <!-- Recent Event Highlights from Blog -->
  {
    eventPostsWithImages.length > 0 && (
      <section class="bg-blue-50 dark:bg-slate-800/50 not-prose">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 py-12 lg:py-16">
          <h2 class="text-2xl font-bold tracking-tight dark:text-white sm:text-3xl mb-4 text-center">
            Recent Event Highlights
          </h2>
          <p class="text-gray-600 dark:text-slate-400 text-center max-w-3xl mx-auto mb-10">
            Read our latest event recaps and community stories from Magento gatherings around the world.
          </p>
          <div class="grid gap-6 md:grid-cols-4">
            {eventPostsWithImages.map((post) => (
              <a
                href={getPermalink(post.permalink, 'post')}
                class="group bg-white dark:bg-slate-800 rounded-xl shadow-md border border-gray-200 dark:border-slate-700 overflow-hidden hover:shadow-lg transition-shadow"
              >
                {post.resolvedImage && (
                  <div class="h-36 overflow-hidden">
                    {typeof post.resolvedImage === 'string' ? (
                      <img
                        src={post.resolvedImage}
                        alt={post.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        loading="lazy"
                      />
                    ) : (
                      <Image
                        src={post.resolvedImage}
                        alt={post.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        widths={[400, 600]}
                        sizes="(max-width: 768px) 100vw, 50vw"
                        loading="lazy"
                      />
                    )}
                  </div>
                )}
                <div class="p-6">
                  <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-slate-500 font-medium mb-3">
                    <Icon name="tabler:calendar" class="w-4 h-4" />
                    {formatDate(post.publishDate)}
                  </div>
                  <h3 class="font-bold dark:text-white text-lg leading-6 mb-2 group-hover:text-primary dark:group-hover:text-blue-400 transition-colors">
                    {post.title}
                  </h3>
                  {post.excerpt && (
                    <p class="text-gray-600 dark:text-slate-400 text-sm line-clamp-3">{post.excerpt}</p>
                  )}
                  <span class="inline-flex items-center text-primary dark:text-blue-400 font-medium text-sm mt-4 group-hover:gap-2 transition-all">
                    Read More
                    <Icon name="tabler:arrow-right" class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" />
                  </span>
                </div>
              </a>
            ))}
          </div>
          <div class="text-center mt-8">
            <a
              href={getPermalink('events', 'category')}
              class="inline-flex items-center gap-2 text-primary dark:text-blue-400 font-medium hover:underline"
            >
              View All Event Recaps
              <Icon name="tabler:arrow-right" class="w-4 h-4" />
            </a>
          </div>
        </div>
      </section>
    )
  }

  <!-- Event Types Section -->
  <section class="px-4 py-12 sm:px-6 mx-auto lg:px-8 max-w-6xl bg-orange-50 dark:bg-slate-800/30 rounded-xl my-8">
    <h2 class="text-2xl font-bold tracking-tight dark:text-white sm:text-3xl mb-8 text-center">Types of Events</h2>
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
      {
        eventTypes.map((type) => (
          <div class="text-center p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm">
            <div class="bg-primary/10 dark:bg-primary/20 p-4 rounded-full inline-block mb-4">
              <Icon name={type.icon} class="w-8 h-8 text-primary dark:text-blue-400" />
            </div>
            <h3 class="text-lg font-semibold dark:text-white mb-2">{type.title}</h3>
            <p class="text-gray-600 dark:text-slate-400 text-sm">{type.description}</p>
          </div>
        ))
      }
    </div>
  </section>

  <section class="px-4 py-8 sm:px-6 mx-auto lg:px-8 lg:py-12 max-w-6xl">
    {
      pastEvents.length > 0 && (
        <section aria-labelledby="past-events-heading">
          <h2 id="past-events-heading" class="text-3xl font-bold tracking-tight dark:text-white sm:text-4xl mb-8">
            Past Events
          </h2>
          <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" role="list">
            {pastEvents.map((event) => (
              <article
                class="bg-gray-50 dark:bg-slate-800/50 rounded-lg p-5 border border-gray-200 dark:border-slate-700 hover:border-gray-300 dark:hover:border-slate-600 transition-colors"
                role="listitem"
              >
                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-slate-500 font-medium mb-2">
                  <Icon name="tabler:calendar" class="w-4 h-4" />
                  {formatDate(event.data.eventDate)}
                </div>
                <h3 class="text-lg font-semibold dark:text-white">{event.data.title}</h3>
                {event.data.location && (
                  <p class="text-gray-500 dark:text-slate-500 text-sm mt-2 flex items-center">
                    <Icon name="tabler:map-pin" class="w-4 h-4 mr-1" />
                    {event.data.location}
                  </p>
                )}
              </article>
            ))}
          </div>
        </section>
      )
    }
  </section>

  <!-- FAQs Section -->
  <FAQs
    title="Frequently Asked Questions"
    subtitle="Everything you need to know about attending and participating in Mage-OS community events."
    columns={2}
    items={[
      {
        title: 'How can I attend a Meet Magento conference?',
        description:
          'Meet Magento conferences are organized regionally by local community members. Visit the specific event website for registration details and ticket information. Many events offer early bird pricing and community discounts.',
      },
      {
        title: 'What are the weekly tech meetings?',
        description:
          'Every week, the Mage-OS community holds open tech meetings on Discord where developers and contributors discuss ongoing development, roadmap priorities, and community initiatives. Anyone is welcome to join and participate.',
      },
      {
        title: 'How can I organize a local Mage-OS event?',
        description:
          'We encourage community members to organize local meetups and events. Contact us at info@mage-os.org for support, promotional materials, and guidance on hosting a successful Mage-OS gathering.',
      },
      {
        title: 'Are events in-person only or also virtual?',
        description:
          'Most major conferences are in-person events, while our weekly tech meetings are held virtually on Discord. Some events also offer hybrid formats with live streaming for remote attendees.',
      },
      {
        title: 'How do I become a speaker at a Mage-OS event?',
        description:
          'Most events have a call for papers or speaker application process. Watch for announcements on our calendar and community channels. We welcome speakers of all experience levels sharing valuable insights.',
      },
      {
        title: 'How do I subscribe to the community calendar?',
        description:
          'You can subscribe to our Google Calendar maintained by Simon Sprankel to stay updated on all upcoming Mage-OS and Magento community events worldwide. The subscribe link is available at the top of this page.',
      },
    ]}
  >
    <Fragment slot="bg">
      <div class="absolute inset-0 bg-orange-50 dark:bg-transparent"></div>
    </Fragment>
  </FAQs>

  <!-- Submit Event CTA -->
  <CallToAction
    title="Have an Event to Share?"
    subtitle="Organizing a Magento or Mage-OS related event? We would love to help spread the word. Submit your event to be featured on our calendar and reach the global community."
    actions={[
      {
        variant: 'primary',
        text: 'Submit an Event',
        href: 'mailto:info@mage-os.org',
        icon: 'tabler:mail',
      },
      {
        text: 'Subscribe to Calendar',
        href: 'https://calendar.google.com/calendar/u/0/embed?src=9ns1e12ucfd84tpnsehekkc6g0@group.calendar.google.com',
        icon: 'tabler:calendar',
        target: '_blank',
      },
    ]}
  >
    <Fragment slot="bg">
      <div class="absolute inset-0 bg-blue-50 dark:bg-transparent"></div>
    </Fragment>
  </CallToAction>

  <!-- Community Note -->
  <section class="px-4 py-8 sm:px-6 mx-auto lg:px-8 max-w-6xl text-center">
    <p class="text-sm text-gray-500 dark:text-slate-500">
      Community calendar maintained by Simon Sprankel. Thank you for supporting the Mage-OS community!
    </p>
  </section>
</Layout>
