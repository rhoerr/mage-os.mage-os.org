---
import { getPartners, getInitials, type PartnerTier } from '~/utils/openCollective';

interface Props {
  speed?: number; // seconds for one complete scroll
  pauseOnHover?: boolean;
}

const { speed = 40, pauseOnHover = true } = Astro.props;

const partners = await getPartners();

// Tier styling - larger sizes with more differentiation
const tierStyles: Record<
  PartnerTier,
  {
    size: string;
    bg: string;
    initialsClass: string;
    nameClass: string;
  }
> = {
  platinum: {
    size: 'h-32 md:h-44',
    bg: 'bg-slate-50 dark:bg-slate-800/50 ring-1 ring-slate-400/50',
    initialsClass: 'text-5xl',
    nameClass: 'text-lg md:text-xl font-bold',
  },
  gold: {
    size: 'h-24 md:h-32',
    bg: 'bg-amber-50 dark:bg-amber-900/20 ring-1 ring-amber-400/50',
    initialsClass: 'text-3xl',
    nameClass: 'text-base md:text-lg font-semibold',
  },
  silver: {
    size: 'h-16 md:h-20',
    bg: 'bg-gray-50 dark:bg-gray-800/30 ring-1 ring-gray-400/50',
    initialsClass: 'text-2xl',
    nameClass: 'text-sm md:text-base font-medium',
  },
  bronze: {
    size: 'h-10 md:h-12',
    bg: 'bg-orange-50/50 dark:bg-orange-900/10 ring-1 ring-orange-400/50',
    initialsClass: 'text-lg',
    nameClass: 'text-xs md:text-sm',
  },
};

const hasPartners = partners.length > 0;
---

{
  hasPartners && (
    <section class="bg-gray-50 dark:bg-slate-800/50 py-8 border-t border-gray-200 dark:border-slate-700 overflow-hidden">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 mb-4">
        <h2 class="text-center text-sm font-medium text-muted uppercase tracking-wider">Our Partners</h2>
      </div>

      <div class="relative marquee-container">
        {/* Gradient masks */}
        <div class="absolute left-0 top-0 bottom-0 w-16 sm:w-24 bg-gradient-to-r from-gray-50 dark:from-slate-800/50 to-transparent z-10 pointer-events-none" />
        <div class="absolute right-0 top-0 bottom-0 w-16 sm:w-24 bg-gradient-to-l from-gray-50 dark:from-slate-800/50 to-transparent z-10 pointer-events-none" />

        {/* Marquee track */}
        <div
          class="marquee-track flex items-center gap-8 md:gap-12"
          style={`--marquee-duration: ${speed}s`}
          data-pause-on-hover={pauseOnHover ? 'true' : 'false'}
        >
          {/* First set */}
          {partners.map((partner) => (
            <a
              href={partner.website || partner.profileUrl}
              target="_blank"
              rel="noopener noreferrer"
              class={`marquee-item flex-shrink-0 flex flex-col items-center justify-center px-4 py-3 rounded-lg transition-transform hover:scale-105 ${tierStyles[partner.tier].bg}`}
              title={`${partner.name} - ${partner.tier.charAt(0).toUpperCase() + partner.tier.slice(1)} Partner`}
            >
              {partner.logoUrl ? (
                <img
                  src={partner.logoUrl}
                  alt={partner.name}
                  class={`${tierStyles[partner.tier].size} w-auto max-w-[200px] object-contain`}
                  loading="lazy"
                  decoding="async"
                />
              ) : (
                <div class={`${tierStyles[partner.tier].size} flex items-center justify-center px-4 min-w-[60px]`}>
                  <span class={`${tierStyles[partner.tier].initialsClass} font-bold text-gray-700 dark:text-gray-300`}>
                    {getInitials(partner.name)}
                  </span>
                </div>
              )}
              <span class={`mt-2 text-center text-gray-700 dark:text-gray-300 ${tierStyles[partner.tier].nameClass}`}>
                {partner.name}
              </span>
            </a>
          ))}

          {/* Duplicate set for seamless loop */}
          {partners.map((partner) => (
            <a
              href={partner.website || partner.profileUrl}
              target="_blank"
              rel="noopener noreferrer"
              class={`marquee-item flex-shrink-0 flex flex-col items-center justify-center px-4 py-3 rounded-lg transition-transform hover:scale-105 ${tierStyles[partner.tier].bg}`}
              title={`${partner.name} - ${partner.tier.charAt(0).toUpperCase() + partner.tier.slice(1)} Partner`}
              aria-hidden="true"
              tabindex="-1"
            >
              {partner.logoUrl ? (
                <img
                  src={partner.logoUrl}
                  alt=""
                  class={`${tierStyles[partner.tier].size} w-auto max-w-[200px] object-contain`}
                  loading="lazy"
                  decoding="async"
                />
              ) : (
                <div class={`${tierStyles[partner.tier].size} flex items-center justify-center px-4 min-w-[60px]`}>
                  <span class={`${tierStyles[partner.tier].initialsClass} font-bold text-gray-700 dark:text-gray-300`}>
                    {getInitials(partner.name)}
                  </span>
                </div>
              )}
              <span class={`mt-2 text-center text-gray-700 dark:text-gray-300 ${tierStyles[partner.tier].nameClass}`}>
                {partner.name}
              </span>
            </a>
          ))}
        </div>
      </div>

      <div class="max-w-7xl mx-auto px-4 sm:px-6 mt-8 text-center">
        <a
          href="/community#partner-tiers"
          class="inline-flex items-center justify-center px-6 py-3 text-sm font-medium text-link bg-transparent border-2 border-link hover:bg-link hover:text-white rounded-full shadow-sm hover:shadow-md transition-all duration-200"
        >
          Support Mage-OS
        </a>
      </div>
    </section>
  )
}

<style>
  .marquee-container {
    position: relative;
    width: 100%;
  }

  .marquee-track {
    display: flex;
    width: max-content;
    animation: marquee-scroll var(--marquee-duration, 40s) linear infinite;
  }

  .marquee-track[data-pause-on-hover='true']:hover {
    animation-play-state: paused;
  }

  @keyframes marquee-scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  /* Accessibility: Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .marquee-track {
      animation: none;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      gap: 1rem;
      padding: 0 1rem;
    }

    .marquee-item[aria-hidden='true'] {
      display: none;
    }
  }
</style>
